#!/usr/bin/env php
<?php

namespace FunkFeuer\Nodeman;

use \FunkFeuer\Nodeman\Config;

require_once __DIR__.'/../vendor/autoload.php';

/* set working directory to root directory */
chdir(dirname(__FILE__).'/../');

/* set default timezone to UTC */
date_default_timezone_set('UTC');

/* allow fetching urls */
ini_set("allow_url_fopen", 1);


function logMsg($msg, $level = 'INFO')
{
    printf("[%s] [%5s] %s\n", date('H:i:s d.m.Y', time()), $level, $msg);
}

$json = @file_get_contents('http://localhost:9090/topology');
if(!$json) {
    logMsg("Failed fetching topology info from olsrd", "ERROR");
    exit(1);
}

$data = json_decode($json);
if(!$data) {
    logMsg("Failed parsing json content from olsrd", "ERROR");
    exit(1);
}

$links = array();
$linkcount = count($data->{'topology'});

/* Remove links and backlinks */
for($i=0; $i < $linkcount; $i++)
{
    $link = $data->{'topology'}[$i];
    if (array_key_exists($link->lastHopIP.'-'.$link->destinationIP, $links) ||
        array_key_exists($link->destinationIP.'-'.$link->lastHopIP, $links)) {
        continue;
    }

    $links[$link->lastHopIP.'-'.$link->destinationIP] = array(
        'from' => $link->lastHopIP,
        'to' => $link->destinationIP,
        'quality' => $link->linkQuality
    );
}

$handle = Config::getDbHandle();
$handle->setAttribute(\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION);
$handle->exec('DELETE FROM linkdata WHERE source = \'olsrd\'');
$handle->exec('UPDATE interfaces SET status = \'offline\' WHERE status = \'online\'');
$handle->exec('UPDATE locations SET status = \'offline\' WHERE status = \'online\'');

foreach($links as $linkdata)
{
    $link = new InterfaceLink();
    $link->quality = $linkdata['quality'];
    $link->source = 'olsrd';

    $fromif = $link->getNetInterfaceByIP($linkdata['from']);
    $toif = $link->getNetInterfaceByIP($linkdata['to']);

    if (!$fromif || !$toif) {
        logMsg('Unknown IP '.$linkdata['from'].' or '.$linkdata['to'], 'WARN');
        continue;
    }

    $link->fromif = $fromif->interfaceid;
    $link->toif = $toif->interfaceid;

    if (!$link->save()) {
        logMsg("Could not insert linkdata", "ERROR");
    }

    $handle->exec('UPDATE interfaces SET status = \'online\' WHERE interfaceid = '.$link->fromif);
    $handle->exec('UPDATE interfaces SET status = \'online\' WHERE interfaceid = '.$link->toif);

    $handle->exec('UPDATE locations SET status = \'online\' WHERE locationid = '.$link->getFromLocation()->locationid);
    $handle->exec('UPDATE locations SET status = \'online\' WHERE locationid = '.$link->getToLocation()->locationid);

    printf("%s -> %s (%f)\n", $linkdata['from'], $linkdata['to'], $linkdata['quality']);
}

exit(0);

